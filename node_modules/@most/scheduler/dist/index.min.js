(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports,require("@most/prelude")):typeof define==="function"&&define.amd?define(["exports","@most/prelude"],e):e(t.mostCore=t.mostCore||{},t.mostPrelude)})(this,function(t,e){"use strict";var r=function t(e,r,n,i,s){this.time=e;this.localOffset=r;this.period=n;this.task=i;this.scheduler=s;this.active=true};r.prototype.run=function t(){return this.task.run(this.time-this.localOffset)};r.prototype.error=function t(e){return this.task.error(this.time-this.localOffset,e)};r.prototype.dispose=function t(){this.scheduler.cancel(this);return this.task.dispose()};var n=function t(e,r){this.origin=e;this.scheduler=r};n.prototype.currentTime=function t(){return this.scheduler.currentTime()-this.origin};n.prototype.scheduleTask=function t(e,r,n,i){return this.scheduler.scheduleTask(e+this.origin,r,n,i)};n.prototype.relative=function t(e){return new n(e+this.origin,this.scheduler)};n.prototype.cancel=function t(e){return this.scheduler.cancel(e)};n.prototype.cancelAll=function t(e){return this.scheduler.cancelAll(e)};var i=function(t){return Promise.resolve(t).then(s)};function s(t){try{return t.run()}catch(e){return t.error(e)}}var o=function t(e,r){var n=this;this.timer=e;this.timeline=r;this._timer=null;this._nextArrival=Infinity;this._runReadyTasksBound=function(){return n._runReadyTasks(n.currentTime())}};o.prototype.currentTime=function t(){return this.timer.now()};o.prototype.scheduleTask=function t(e,n,i,s){var o=this.currentTime()+Math.max(0,n);var u=new r(o,e,i,s,this);this.timeline.add(u);this._scheduleNextRun();return u};o.prototype.relative=function t(e){return new n(e,this)};o.prototype.cancel=function t(e){e.active=false;if(this.timeline.remove(e)){this._reschedule()}};o.prototype.cancelAll=function t(e){this.timeline.removeAll(e);this._reschedule()};o.prototype._reschedule=function t(){if(this.timeline.isEmpty()){this._unschedule()}else{this._scheduleNextRun(this.currentTime())}};o.prototype._unschedule=function t(){this.timer.clearTimer(this._timer);this._timer=null};o.prototype._scheduleNextRun=function t(){if(this.timeline.isEmpty()){return}var e=this.timeline.nextArrival();if(this._timer===null){this._scheduleNextArrival(e)}else if(e<this._nextArrival){this._unschedule();this._scheduleNextArrival(e)}};o.prototype._scheduleNextArrival=function t(e){this._nextArrival=e;var r=Math.max(0,e-this.currentTime());this._timer=this.timer.setTimer(this._runReadyTasksBound,r)};o.prototype._runReadyTasks=function t(){this._timer=null;this.timeline.runTasks(this.currentTime(),s);this._scheduleNextRun()};var u=function t(){this.tasks=[]};u.prototype.nextArrival=function t(){return this.isEmpty()?Infinity:this.tasks[0].time};u.prototype.isEmpty=function t(){return this.tasks.length===0};u.prototype.add=function t(e){a(e,this.tasks)};u.prototype.remove=function t(r){var n=m(p(r),this.tasks);if(n>=0&&n<this.tasks.length){var i=e.findIndex(r,this.tasks[n].events);if(i>=0){this.tasks[n].events.splice(i,1);return true}}return false};u.prototype.removeAll=function t(e){var r=this;for(var n=0;n<this.tasks.length;++n){v(e,r.tasks[n])}};u.prototype.runTasks=function t(e,r){var n=this;var i=this.tasks;var s=i.length;var o=0;while(o<s&&i[o].time<=e){++o}this.tasks=i.slice(o);for(var u=0;u<o;++u){n.tasks=c(r,i[u].events,n.tasks)}};function c(t,e,r){for(var n=0;n<e.length;++n){var i=e[n];if(i.active){t(i);if(i.period>=0&&i.active){i.time=i.time+i.period;a(i,r)}}}return r}function a(t,e){var r=e.length;var n=p(t);if(r===0){e.push(d(n,[t]));return}var i=m(n,e);if(i>=r){e.push(d(n,[t]))}else{h(t,e,n,i)}}function h(t,e,r,n){var i=e[n];if(r===i.time){l(t,i.events,r)}else{e.splice(n,0,d(r,[t]))}}function l(t,e){if(e.length===0||t.time>=e[e.length-1].time){e.push(t)}else{f(t,e)}}function f(t,e){for(var r=0;r<e.length;r++){if(t.time<e[r].time){e.splice(r,0,t);break}}}function p(t){return Math.floor(t.time)}function v(t,r){r.events=e.removeAll(t,r.events)}function m(t,e){var r=0;var n=e.length;var i,s;while(r<n){i=Math.floor((r+n)/2);s=e[i];if(t===s.time){return i}else if(t<s.time){n=i}else{r=i+1}}return n}var d=function(t,e){return{time:t,events:e}};var y=function t(e){this._clock=e};y.prototype.now=function t(){return this._clock.now()};y.prototype.setTimer=function t(e,r){return r<=0?T(e):setTimeout(e,r)};y.prototype.clearTimer=function t(e){return e instanceof k?e.cancel():clearTimeout(e)};var k=function t(e){this.f=e;this.active=true};k.prototype.run=function t(){return this.active&&this.f()};k.prototype.error=function t(e){throw e};k.prototype.cancel=function t(){this.active=false};function T(t){var e=new k(t);i(e);return e}var w=function t(e,r){this.origin=r;this.clock=e};w.prototype.now=function t(){return this.clock.now()-this.origin};var _=function t(e,r){this.origin=r;this.hrtime=e};_.prototype.now=function t(){var e=this.hrtime(this.origin);return(e[0]*1e9+e[1])/1e6};var g=function(t){return new w(t,t.now())};var x=function(){return g(performance)};var A=function(){return g(Date)};var R=function(){return new _(process.hrtime,process.hrtime())};var C=function(){if(typeof performance!=="undefined"&&typeof performance.now==="function"){return x()}else if(typeof process!=="undefined"&&typeof process.hrtime==="function"){return R()}return A()};var N=function(t){return t.currentTime()};var M=e.curry2(function(t,e){return e.scheduleTask(0,0,-1,t)});var P=e.curry3(function(t,e,r){return r.scheduleTask(0,t,-1,e)});var D=e.curry3(function(t,e,r){return r.scheduleTask(0,0,t,e)});var E=function(t){return t.dispose()};var O=e.curry2(function(t,e){return e.cancelAll(t)});var b=e.curry2(function(t,e){return new n(t,e)});var I=e.curry2(function(t,e){return new o(t,e)});var j=function(){return new o(B(),new u)};var B=function(){return new y(C())};var H=function(t){return new y(t)};var S=function(){return new u};t.newScheduler=I;t.newDefaultScheduler=j;t.newDefaultTimer=B;t.newClockTimer=H;t.newTimeline=S;t.RelativeClock=w;t.HRTimeClock=_;t.clockRelativeTo=g;t.newPerformanceClock=x;t.newDateClock=A;t.newHRTimeClock=R;t.newPlatformClock=C;t.currentTime=N;t.asap=M;t.delay=P;t.periodic=D;t.cancelTask=E;t.cancelAllTasks=O;t.schedulerRelativeTo=b;Object.defineProperty(t,"__esModule",{value:true})});